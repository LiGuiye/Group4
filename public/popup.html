<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="libs/ol/ol.css" />
		<link rel="stylesheet" href="libs/jsonformat/jsonExtend.css" />
		<script type="text/javascript" src="libs/ol/ol-debug.js" ></script>
		<script type="text/javascript" src="libs/jquery-1.11.2.min.js" ></script>
		<script type="text/javascript" src="libs/zondyClient.js" ></script>	
		<script type="text/javascript" src="libs/jsonformat/json2.js" ></script>
		<script type="text/javascript" src="libs/jsonformat/jsonExtend.js" ></script>
		<style>
			#mapcon {
				width: 100%;
				height: 100%;
				position: absolute;
			}
			#btn {
		      top: 150px;
		      right: 50px;
		      position: absolute;
		      z-index: 99;
		      background-color: white;
		      border-radius: 8px;
		      padding: 10px;
		      opacity: 0.75;
		    }
		    #tab {
		      width: 100%;
			  height: 200px;
		      bottom: 0px;
		      position: absolute;
		      z-index: 99;
		      background-color: white;
		      border-radius: 8px;
		      padding: 10px;
		      opacity: 0.75;
		      overflow: scroll;
		    }
			td{
				width: 130px;
				height: 10px;
				text-align: center;
			}			
			
        .ol-popup {
            position: absolute;
            background-color: white;
            -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 45px;
            left: -50px;
        }

            .ol-popup:after, .ol-popup:before {
                top: 100%;
                border: solid transparent;
                content: " ";
                height: 0;
                width: 0;
                position: absolute;
                pointer-events: none;
            }

            .ol-popup:after {
                border-top-color: white;
                border-width: 10px;
                left: 48px;
                margin-left: -10px;
            }

            .ol-popup:before {
                border-top-color: #cccccc;
                border-width: 11px;
                left: 48px;
                margin-left: -11px;
            }

        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }

            .ol-popup-closer:after {
                content: "✖";
            }

        #popup-content {
            font-size: 14px;
            font-family: "微软雅黑";
        }

            #popup-content .markerInfo {
                font-weight: bold;
            }
		</style>
	</head>
	<body>		
	    <div id="mapcon">
	    	<div id="popup" class="ol-popup">	    		
                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                <div id="popup-content"></div>
            </div>
            
            <span id="btn">	
            	<input type="text" id="sstext"/><input type="button" value="搜索" onclick="sscx()"/></br>
				<input type="button" value="周边查询"  onclick="zbcx()"/></br>
			    <input type="button" value="模糊查询" onclick="mhcx()"/>
           </span>
            <div id="tab">
	           	<table border="1">  
				</table>				
				<table border="1" id="tab1" class="table">
				</table>               
            </div>          
	    </div>
     <script>
     	//地图文档名称
        var docName = "光谷智慧交通";
        //查询图层索引
        var layerIndex = 3;
        var zb;
        //创建地图文档
        var mapDocLayer = new Zondy.Map.Doc(docName, docName, {
            //IP地址
            ip: "127.0.0.1",
            //端口号
            port: "6163",
            layers: "show:3",
        });
        var TiandiMap_vec = new ol.layer.Tile({
            title: "天地图矢量图层",
            source: new ol.source.XYZ({
                url: "http://t0.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}&tk=5c3ef488053a73450772239c6c4249ec",//parent.TiandituKey()为天地图密钥
                wrapX: false,
                //crossOrigin: "Anonymous"
            })
        });
        var Tianditu_cva = new ol.layer.Tile({
            title: "天地图矢量注记图层",
            source: new ol.source.XYZ({
                url: "http://t0.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}&tk=5c3ef488053a73450772239c6c4249ec",//parent.TiandituKey()为天地图密钥
                wrapX: false,
                //crossOrigin: "Anonymous"
            })
        });
        //实例化Map对象加载地图,默认底图加载MapQuest地图
        var map = new ol.Map({
            //指定地图所在的网页div元素的id
            target: 'mapcon',
            //指定加载的图层
            layers: [TiandiMap_vec,Tianditu_cva,mapDocLayer],
            //指定地图视图
            view: new ol.View({
                //设置地图投影坐标系
                projection: "EPSG:4326",               
                //设置地图当前显示级数
                zoom: 12,
                //设置地图显示中心
				center: [(114.32110382470053+114.41798540197931)/2 , (30.46038194250228+30.52896194250228)/2]
            })
        });
        //实现popup的html元素
	    var container = document.getElementById('popup');
	    var content = document.getElementById('popup-content');
	    var closer = document.getElementById('popup-closer');
	
	    //在地图容器中创建一个Overlay
	    var popup = new ol.Overlay({
	        //要转换成overlay的HTML元素
	        element: container,
	        //当前窗口可见
	        autoPan: true,
	        //Popup放置的位置
	        positioning: 'bottom-center',
	        //是否应该停止事件传播到地图窗口
	        stopEvent: false,
	        autoPanAnimation: {
	            //当Popup超出地图边界时，为了Popup全部可见，地图移动的速度
	            duration: 250
	        }
	    });
	    map.addOverlay(popup);
        //添加关闭按钮的单击事件（隐藏popup）
        closer.onclick = function () {
            //未定义popup位置
            popup.setPosition(undefined);
            //失去焦点
            closer.blur();
            return false;
        };
        
	    //为map添加鼠标移动事件监听，当指向标注时改变鼠标光标状态
        map.on('pointermove', function (e) {
            var pixel = map.getEventPixel(e.originalEvent);
            var hit = map.hasFeatureAtPixel(pixel);
            map.getTargetElement().style.cursor = hit ? 'pointer' : '';
        });
        
        var tab1 = document.getElementById('tab1');
        var vectorSource = new ol.source.Vector(); //图层数据源
        //矢量标注图层
        var vectorLayer = new ol.layer.Vector({
            source: vectorSource
        });
        map.addLayer(vectorLayer);
        function zbcx(){
        	tab1.innerHTML = null;
        	document.getElementById("sstext").value= null;
        	vectorSource.clear();
        	map.addInteraction(draw);
	        //注册绘制结束的监听事件
	        draw.on('drawend', drawControlback);
        }
        function sscx(){
        	tab1.innerHTML = null;
        	vectorSource.clear();
        	var sstext = document.getElementById("sstext").value;
        	var stext = "事件编号 LIKE '%" + sstext + "%' OR 驾驶员 LIKE '%" + sstext + "%' OR 处理状态 LIKE '%" + sstext + "%' OR 事件类型 LIKE '%" + sstext + "%' OR 事件等级 LIKE '%" + sstext + "%' OR 发生时间 LIKE '%" + sstext + "%' OR 发生地点 LIKE '%" + sstext + "%' OR 车牌号 LIKE '%" + sstext + "%'";
			//  
			// 
			// 
			// 
			// 
			
        	//var stext = "事件类型='" + sstext +"'" ;
        	//初始化查询结构对象，设置查询结构包含几何信息
            var queryStruct = new Zondy.Service.QueryFeatureStruct();
            //是否包含几何图形信息
            queryStruct.IncludeGeometry = true;
            //是否包含属性信息
            queryStruct.IncludeAttribute = true;
            //是否包含图形显示参数
            queryStruct.IncludeWebGraphic = false;
            //实例化查询参数对象
            var queryParam = new Zondy.Service.QueryParameter({
                resultFormat: "json",
                struct: queryStruct
            });
            //设置查询分页号
            queryParam.pageIndex = 0;
            //设置查询要素数目
            queryParam.recordNumber = 20;
            //设置属性条件
            queryParam.where = stext;
            //实例化地图文档查询服务对象
            var queryService = new Zondy.Service.QueryDocFeature(queryParam, docName, layerIndex, {               
                ip: "127.0.0.1",//IP地址              
                port: "6163"//端口号
            });
            //执行查询操作，querySuccess为查询回调函数
            queryService.query(querySuccess, queryError);
        }
        function mhcx(){       	
        	tab1.innerHTML = null;
        	document.getElementById("sstext").value= null;
        	vectorSource.clear();       	
        }
        
        //创建绘图控件
        var draw = new ol.interaction.Draw({
            type: "Circle",
        });
        
         //执行点击查询
        function drawControlback(data) {
            //初始化查询结构对象，设置查询结构包含几何信息
            var queryStruct = new Zondy.Service.QueryFeatureStruct();
            //是否包含几何图形信息
            queryStruct.IncludeGeometry = true;
            //是否包含属性信息
            queryStruct.IncludeAttribute = true;
            //是否包含图形显示参数
            queryStruct.IncludeWebGraphic = false;
            //创建一个用于查询的圆形状
            var geomObj = new Zondy.Object.Circle();
            geomObj.setByOL(data.feature.getGeometry());
            //指定查询规则
            var rule = new Zondy.Service.QueryFeatureRule({
                //是否将要素的可见性计算在内
                EnableDisplayCondition: true,
                //是否仅比较要素的外包矩形
                CompareRectOnly: false,
                //是否完全包含
                MustInside: false,
                //是否相交
                Intersect: true
            });

            //实例化查询参数对象
            var queryParam = new Zondy.Service.QueryParameter({
                geometry: geomObj,
                resultFormat: "json",
                struct: queryStruct,
                rule: rule
            });
            //设置查询分页号
            queryParam.pageIndex = 0;
            //设置查询要素数目
            queryParam.recordNumber = 20;
            //实例化地图文档查询服务对象
            var queryService = new Zondy.Service.QueryDocFeature(queryParam, docName, layerIndex, {
                //IP地址
                ip: "127.0.0.1",
                //端口号
                port: "6163"
            });
            //执行查询操作，querySuccess为查询回调函数
            queryService.query(querySuccess, queryError);
        }

		//查询失败回调
        function queryError(e) {
            alert("查询失败!");
        }
        var sid;
        
                        
        var createLabelStyle = function (feature) {
            return new ol.style.Style({
                image: new ol.style.Icon(
                    {
                        anchor: [0.5, 1], //图片中心
		                anchorOrigin: 'top-left', //标注样式的起点位置
		                anchorXUnits: 'fraction', //X方向单位：分数
		                anchorYUnits: 'fraction', //Y方向单位：分数		                        
                        //opacity: 0.75,//透明度		                        
                        src: 'img/mark.png'//图标的url
                    }),
            });
        }
        
		//为map添加点击事件监听，渲染弹出popup
	    map.on('click', function (evt) {
	    	popup.getPosition(undefined);
	        //判断当前单击处是否有要素，捕获到要素时弹出popup
	        var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) { return feature; });
	        if (feature && feature.getProperties().attribute) {
	        	popup.setPosition(undefined);
	            //清空popup的内容容器
	            content.innerHTML = '';
	            //在popup中加载当前要素的具体信息
	            addFeatrueInfo(feature.getProperties().attribute);
	            if (popup.getPosition() == undefined) {
	                //设置popup的位置
	                popup.setPosition(feature.getGeometry().getCoordinates());
	            }
	        }
	    });
	    
		$(document).on("click", "#tab1 tbody tr", function(){
	        var sid = $(this).attr("value");
	        var view = map.getView();       	
        	view.setZoom(15);
        	sid = sid.split(",");
        	view.setCenter([Number(sid[0]), Number(sid[1])]);
        })

        //查询成功回调
        function querySuccess(result) {
        	map.removeInteraction(draw);
            if (result.TotalCount) {
            	var sxsz = result.SFEleArray;
            	var codes = "<thead>"+
							"<tr>"+
							  "<th >事件编号</th>"+
							  "<th>事件类型</th>"+
							  "<th>事件等级</th>"+
							  "<th>发生时间</th>"+
							  "<th>发生地点</th>"+
							  "<th>车牌号</th>"+
							  "<th>驾驶员</th>"+
							  "<th>处理状态</th>"+
							"</tr>"+
						"</thead>"+
					"<tbody>";
	        	for (i = 0; i < sxsz.length; i++) {
	        		var x = sxsz[i].fGeom.PntGeom["0"].Dot.x;
	                var y = sxsz[i].fGeom.PntGeom["0"].Dot.y;
	                zb = [x,y];	
	        		var sxbg = result.SFEleArray[i].AttValue;
	        		var code = "";
	        		for (m = 0; m < sxbg.length-1; m++){
						code += "<td >" + sxbg[m] + "</td>";
	        		}
	        		codes += "<tr  value ='"+x+","+y+"'>" + code + "</tr>";	        		
//	        		tab1.innerHTML += codes;	        		
	                var featuerInfo = {
			            geo: zb,
			            att: {		                		                
			                text: [sxbg],//标注内容
			            }
			        }	
	                
	                //实例化Vector要素，通过矢量图层添加到地图容器中
			        var iconFeature = new ol.Feature({		            
			            geometry: new ol.geom.Point(zb),//坐标点
			            attribute:featuerInfo
			        });
			        iconFeature.setStyle(createLabelStyle(iconFeature));
			        //矢量标注的数据源
			        vectorSource.addFeature(iconFeature);
				        
				}
	        	codes += "</tbody>";
	        	$("#tab1").append(codes);
            } else {
                alert("未查询到要素！");
            }
        }
		
        //动态创建popup的具体内容
        function addFeatrueInfo(info) {
            //新增div元素
            var elementDiv = document.createElement('div');
            elementDiv.className = "markerText";
            //elementDiv.innerText = info.att.text;
            setInnerText(elementDiv, info.att.text);
            // 为content添加div子节点
            content.appendChild(elementDiv);
        }

        //动态设置元素文本内容（兼容）
        function setInnerText(element, text) {
            if (typeof element.textContent == "string") {
                element.textContent = text;
            } else {
                element.innerText = text;
            }
        }
       </script>
	</body>
</html>
